<?php
#/usr/bin/php
/**
 * @param $blueprint
 * @param string $path
 */
function main( $blueprint, $path = 'htdocs', $site_name, $domain ) {
	echo "Setting up blueprint $blueprint...\n";
	$blueprints = json_decode( file_get_contents( 'vv-blueprints.json' ) );

	if ( ! empty( $blueprints->$blueprint->demo_content ) ) {
		system( 'wp --allow-root plugin is-installed wordpress-importer', $importer_missing );
		if ( $importer_missing ) {
			exec( 'wp --allow-root plugin install wordpress-importer --activate' );
		}
		echo "Importing content...\n";
		foreach ( $blueprints->$blueprint->demo_content as $demo ) {
			import_demo_content( $demo );
		}
	}
	if ( ! empty( $blueprints->$blueprint->themes ) ) {
		echo "Installing themes...\n";
		foreach ( $blueprints->$blueprint->themes as $theme ) {
			install( 'theme', $theme, $path, $site_name, $domain );
		}
	}
	if ( ! empty( $blueprints->$blueprint->plugins ) ) {
		echo "Installing plugins...\n";
		foreach ( $blueprints->$blueprint->plugins as $plugin ) {
			install( 'plugin', $plugin, $path, $site_name, $domain );
		}
	}
	if ( ! empty( $blueprints->$blueprint->mu_plugins ) ) {
		echo "Installing mu-plugins...\n";
		foreach ( $blueprints->$blueprint->mu_plugins as $mu_plugin ) {
			install( 'mu-plugin', $mu_plugin, $path, $site_name, $domain );
		}
	}
	if ( ! empty( $blueprints->$blueprint->network_options ) ) {
		echo "Setting up network options...\n";
		foreach ( $blueprints->$blueprint->network_options as $option ) {
			add_network_option( $option );
		}
	}
	if ( ! empty( $blueprints->$blueprint->options ) ) {
		echo "Setting up options...\n";
		foreach ( $blueprints->$blueprint->options as $option ) {
			add_option( $option );
		}
	}
	if ( ! empty( $blueprints->$blueprint->widgets ) ) {
		echo "Setting up widgets...\n";
		foreach ( $blueprints->$blueprint->widgets as $widget ) {
			add_widget( $widget );
		}
	}
	if ( ! empty( $blueprints->$blueprint->defines ) ) {
		echo 'Adding constants to wp-config.php...';
		foreach ( $blueprints->$blueprint->defines as $define ) {
			add_define( $define, $path );
		}
	}

	echo "Blueprint set up.\n";
}

/**
 * @param $type
 * @param $object
 * @param $path
 */
function install( $type, $object, $path, $site_name, $domain ) {
	/**
	 * Set up the base command, make the wp-content folders and move into them
	 * (-p: no error if existing, make parent directories as needed)
	 */
	$command = "mkdir -p $path/wp-content/{$type}s && cd $path/wp-content/{$type}s";

	/**
	 * Set up the string variable that will hold the WP-CLI options
	 */
	$wpcli_options = '';

	/**
	 * Get the target object we need to install
	 */
	$target = $object;

	/**
	 * This boolean tells if this blueprint is WP-CLI compatible.
	 */
	$wpcli_compat = false;

	/**
	 * If our target is an object, get the location of that object
	 * and set up the WP-CLI options for this installation
	 * Documentation: http://wp-cli.org/commands/plugin/install/ && http://wp-cli.org/commands/theme/install/
	 *
	 * If the target is not an object, this is a target object from an old blueprint. This way we keep backwards compatibility
	 */
	if ( is_object( $target ) ) {
		$target = $object->location;

		// Allow for sitename and sitedomain placeholders inside of a blueprints file
		$target = str_replace( 'SITENAME', $site_name,  $target );
		$target = str_replace( 'SITEDOMAIN', $domain,  $target );

		$wpcli_compat = true;

		if ( isset( $object->version ) ) {
			$wpcli_options .= " --version=$object->version";
		}
		if ( isset( $object->force ) && true == $object->force ) {
			$wpcli_options .= ' --force';
		}
		if ( isset( $object->activate ) && true == $object->activate ) {
			$wpcli_options .= ' --activate';
		}
		if ( isset( $object->activate_network ) && true == $object->activate_network && 'plugin' == $type ) {
			$wpcli_options .= ' --activate-network';
		}
	}

	/**
	 * Give feedback to the console
	 */
	echo '  Installing ' . $target . $wpcli_options . "...\n";

	/**
	 * Set up the rest of the command for this installation depending
	 * on the type of installation we are going to do
	 */
	// Clone a git repository
	if ( false !== strpos( $target, '.git' ) ) {
		$command .= " && git clone $target";
		if ( $wpcli_compat ) {
			$command .= $wpcli_options;
		}
	}
	// Download a zip file from a specified location
	elseif ( false !== strpos( $target, '.zip' ) ) {
		$command .= " && wp --allow-root $type install $target";
		if ( $wpcli_compat ) {
			$command .= $wpcli_options;
		}
	}
	// Download a git repository based on username and repository name
	elseif ( false !== strpos( $target, '/' ) ) {
		// Get the folder name
		$exploded = explode( '/', $target );
		$folder = $exploded[1];

		// Check if the blueprint is WP-CLI compatible
		if ( ! $wpcli_compat ) {
			$command .= " && wp --allow-root $type install https://github.com/$target/archive/master.zip && pwd && mv $folder-master $folder";
		} else {
			$command .= " && curl -s -S \"https://codeload.github.com/$target/tar.gz/master\" -o \"$folder-master.tar.gz\"".    // Download the tarball from the repository, do it silent but show errors
			" && tar xpvf $folder-master.tar.gz". // Unzip the file
			' && pwd'. // Print working directory
			" && mv $folder-master $folder" . // Move the files so te folder has the same name as the repository
			" && rm $folder-master.tar.gz"; // Remove our file

			// Activate the plugin using WP-CLI
			if ( isset( $object->activate ) && true == $object->activate ) {
				$command .= " && wp --allow-root $type activate $folder";
			}
			if ( isset( $object->activate_network ) && true == $object->activate_network && 'plugin' == $type ) {
				$command .= " && wp --allow-root $type activate $folder --network";
			}
		}
	}
	// Download the plugin from the WP Plugin repository based on the URL slug
	else {
		$command .= " && wp --allow-root $type install $target";
		if ( $wpcli_compat ) {
			$command .= $wpcli_options;
		}
	}

	/**
	 * Finish up the command
	 */
	$command .= ' && cd -';

	/**
	 * Execute the command
	 */
	exec( $command );
}

/**
 * Reads a double-colon separated option from a blueprint.
 *
 * @param $opt_string
 *
 * @return array
 */
function parse_option( $opt_string ) {
	$x = explode( '::', $opt_string );
	$key = array_shift( $x );
	$val = implode( '::', $x );
	return array( $key => $val );
}

/**
 * @todo Make the network ID a variable, too. Right now it's hardcoded as `1`.
 *
 * @param $option
 */
function add_network_option( $option ) {
	$opt = parse_option( $option );
	$name = key( $opt );
	exec( 'wp --allow-root network meta delete 1 ' . escapeshellarg( $name ) );

	$vals = array_pop( $opt );
	$php_vals = @unserialize( $vals );
	if ( false === $php_vals ) {
		exec( 'wp --allow-root network meta add 1 ' . escapeshellarg( $name ) . ' ' . escapeshellarg( $vals ) );
	} else {
		$json = json_encode( $php_vals );
		exec( 'wp --allow-root network meta add 1 ' . escapeshellarg( $name ) . ' ' . escapeshellarg( $json) . ' --format=json');
	}

	echo "  Insert network settings $name...\n";
}

/**
 * @param $option
 */
function add_option( $option ) {
	$opt = parse_option( $option );
	$name = key( $opt );
	exec( 'wp --allow-root option delete ' . escapeshellarg( $name ) );

	$vals = array_pop( $opt );
	$php_vals = @unserialize( $vals );
	if ( false === $php_vals ) {
		exec( 'wp --allow-root option add ' . escapeshellarg( $name ) . ' ' . escapeshellarg( $vals ) );
	} else {
		$json = json_encode( $php_vals );
		exec( 'wp --allow-root option add ' . escapeshellarg( $name ) . ' ' . escapeshellarg( $json ) . ' --format=json' );
	}

	echo "  Insert settings $name...\n";
}

function activate_wordpress_importer() {
	exec( 'wp plugin install wordpress-importer --allow-root && wp plugin activate wordpress-importer --allow-root' );
}

/**
 * @param $demo
 */
function import_demo_content( $demo ) {
	$opt = parse_option( $demo );
	$link = array_pop( $opt );
	exec( 'curl -s ' . escapeshellarg( $link ) . ' > import.xml && wp import import.xml --authors=create --allow-root && rm import.xml' );
	echo "  Import Complete!\n";
}

/**
 * @param $object
 * @param $path
 */
function add_define( $object, $path ) {
	$opt = parse_option( $object );
	$def = key( $opt );
	$val = array_pop( $opt );
	echo "  Insert constants $def...\n";

	/**
	 * Changed is_bool to a string comparison because is_bool only works for real booleans, not strings
	 * Reference: http://stackoverflow.com/questions/7336861/how-to-convert-string-to-boolean-php
	 */
	if ( 'true' == strtolower( $val ) || 'false' == strtolower( $val ) ) {
		exec( '     echo "$(sed "34a\\
define(\"'. $def . '\",' . $val  . ');
" ./' . $path . '/wp-config.php);" > ./' . $path . '/wp-config.php' );
	} else {
		exec( '		echo "$(sed "34a\\
define(\"'. $def . '\",\"' . $val  . '\");
" ./' . $path . '/wp-config.php);" > ./' . $path . '/wp-config.php' );
	}
}

/**
 * @param $object
 */
function add_widget( $object ) {
	echo "  Adding widget {$object->name} to {$object->location}...\n";
	$cmd = sprintf(
		'wp --allow-root widget add %s %s',
		escapeshellarg( $object->name ),
		escapeshellarg( $object->location )
	);
	if ( isset($object->position) ) {
		$cmd .= ' ' . escapeshellarg( $object->position );
	}
	if ( isset( $object->options ) ) {
		foreach ( $object->options as $key => $value ) {
			$cmd .= ' ' . escapeshellarg( "--$key=$value" );
		}
	}
	exec( $cmd );
}

main( $argv[1], $argv[2], $argv[3], $argv[4] );
